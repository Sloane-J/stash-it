<!DOCTYPE html>
<html>
<head>
  <title>Image Upload Test - Stash It</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
    }
    h1 {
      margin-bottom: 10px;
    }
    .section {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    .form-group {
      margin-bottom: 12px;
    }
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 5px;
    }
    input[type=file] {
      margin-bottom: 10px;
    }
    button {
      background: #2563eb;
      color: white;
      padding: 9px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
    }
    button:hover {
      background: #1d4ed8;
    }
    #result {
      margin-top: 20px;
      padding: 15px;
      background: #f3f4f6;
      border-radius: 6px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 14px;
    }
    .error { background: #fee; color: #900; }
    .success { background: #efe; color: #060; }

    .image-card {
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 15px;
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .thumb {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .delete-btn {
      background: #b91c1c;
      margin-left: auto;
    }
    .delete-btn:hover {
      background: #991b1b;
    }
  </style>
</head>
<body>

  <h1>Image Upload Tester</h1>
  <p>Talks directly to your API routes. Make sure your server is running on port 3000.</p>

  <!-- UPLOAD SECTION -->
  <div class="section">
    <h2>Upload Image</h2>
    <form id="uploadForm">
      <div class="form-group">
        <label>Select Image</label>
        <input type="file" id="fileInput" accept="image/*" required>
      </div>

      <div class="form-group">
        <label>Snippet ID (optional)</label>
        <input type="text" id="snippetId" placeholder="Leave empty for standalone upload">
      </div>

      <button type="submit">Upload</button>
    </form>

    <div id="result"></div>
  </div>

  <!-- IMAGE LIST SECTION -->
  <div class="section">
    <h2>Your Images</h2>
    <button onclick="loadImages()">Refresh List</button>
    <div id="imageList" style="margin-top:20px;"></div>
  </div>

<script>
const API = "http://localhost:3000/api/images";

document.getElementById("uploadForm").onsubmit = async (e) => {
  e.preventDefault();
  
  const resultDiv = document.getElementById("result");
  resultDiv.textContent = "Uploading...";
  resultDiv.className = "";

  try {
    const formData = new FormData();
    const file = document.getElementById("fileInput").files[0];
    const snippetId = document.getElementById("snippetId").value.trim();

    formData.append("file", file);
    if (snippetId) formData.append("snippetId", snippetId);

    const res = await fetch(`${API}/upload`, {
      method: "POST",
      body: formData,
      credentials: "include"
    });

    const json = await res.json();

    if (!res.ok) {
      resultDiv.className = "error";
      resultDiv.textContent = JSON.stringify(json, null, 2);
    } else {
      resultDiv.className = "success";
      resultDiv.textContent = JSON.stringify(json, null, 2);
      loadImages();
    }

  } catch (err) {
    resultDiv.className = "error";
    resultDiv.textContent = err.message;
  }
};

async function loadImages() {
  const container = document.getElementById("imageList");
  container.textContent = "Loading...";

  try {
    const res = await fetch(API, {
      method: "GET",
      credentials: "include"
    });

    const json = await res.json();

    if (!res.ok) {
      container.innerHTML = `<div class="error">${JSON.stringify(json, null, 2)}</div>`;
      return;
    }

    if (!json.images.length) {
      container.textContent = "No images uploaded yet.";
      return;
    }

    container.innerHTML = "";
    json.images.forEach(img => {
      const card = document.createElement("div");
      card.className = "image-card";
      card.innerHTML = `
        <img class="thumb" src="${img.thumbnailUrl}">
        <div>
          <div><strong>ID:</strong> ${img.id}</div>
          <div><strong>Size:</strong> ${(img.fileSize / (1024 * 1024)).toFixed(2)}MB</div>
          <a href="${img.imagekitUrl}" target="_blank">Open full image</a>
        </div>
        <button class="delete-btn" onclick="deleteImage('${img.id}')">Delete</button>
      `;
      container.appendChild(card);
    });

  } catch (err) {
    container.innerHTML = `<div class="error">${err.message}</div>`;
  }
}

async function deleteImage(id) {
  if (!confirm("Delete this image?")) return;

  const res = await fetch(`${API}/${id}`, {
    method: "DELETE",
    credentials: "include"
  });

  const json = await res.json();

  if (!res.ok) {
    alert(JSON.stringify(json));
    return;
  }

  loadImages();
}

// Load list on page open
loadImages();
</script>

</body>
</html>
